name: CI / Build & Push Docker images to Docker Hub

on:
  push:
    branches:
      - main

env:
  DOCKERHUB_NAMESPACE: ${{ secrets.DOCKERHUB_USERNAME }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: m2-cache-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: m2-cache-${{ runner.os }}-

      - name: Build backend_userService
        run: |
          cd backend_userService
          mvn -B clean package -DskipTests
          cd ..

      - name: Build backend_messageService
        run: |
          cd backend_messageService
          mvn -B clean package -DskipTests
          cd ..

      - name: Build backend_nearbyService
        run: |
          cd backend_nearbyService
          mvn -B clean package -DskipTests
          cd ..

      - name: Build backend_followService
        run: |
          cd backend_followService
          mvn -B clean package -DskipTests
          cd ..

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Cache frontend node_modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: frontend-node-modules-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: frontend-node-modules-

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- Debug Step to Check Secrets ---
      - name: Debug GitHub Secrets
        run: |
          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
            echo "DOCKERHUB_USERNAME is missing!"
            exit 1
          else
            echo "DOCKERHUB_USERNAME is set"
          fi

          if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "DOCKERHUB_TOKEN is missing!"
            exit 1
          else
            echo "DOCKERHUB_TOKEN is set"
          fi

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push backend_userService image
        uses: docker/build-push-action@v4
        with:
          context: ./backend_userService
          file: ./backend_userService/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_userservice:latest
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_userservice:${{ env.IMAGE_TAG }}

      - name: Build & push backend_messageService image
        uses: docker/build-push-action@v4
        with:
          context: ./backend_messageService
          file: ./backend_messageService/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_messageservice:latest
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_messageservice:${{ env.IMAGE_TAG }}

      - name: Build & push backend_nearbyService image
        uses: docker/build-push-action@v4
        with:
          context: ./backend_nearbyService
          file: ./backend_nearbyService/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_nearbyservice:latest
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_nearbyservice:${{ env.IMAGE_TAG }}

      - name: Build & push backend_followService image
        uses: docker/build-push-action@v4
        with:
          context: ./backend_followService
          file: ./backend_followService/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_followservice:latest
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_followservice:${{ env.IMAGE_TAG }}

      - name: Build & push frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_NAMESPACE }}/frontend:latest
            ${{ env.DOCKERHUB_NAMESPACE }}/frontend:${{ env.IMAGE_TAG }}
