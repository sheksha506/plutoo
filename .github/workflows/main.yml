name: CI / Build & Push Docker images to Docker Hub

on:
  push:
    branches:
      - main

env:
  DOCKERHUB_NAMESPACE: ${{ secrets.DOCKERHUB_USERNAME }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: m2-cache-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: m2-cache-${{ runner.os }}-

      - name: Build backend_userService
        run: |
          cd backend_userService
          mvn -B clean package -DskipTests
          cd ..

      - name: Build backend_messageService
        run: |
          cd backend_messageService
          mvn -B clean package -DskipTests
          cd ..

      - name: Build backend_nearbyService
        run: |
          cd backend_nearbyService
          mvn -B clean package -DskipTests
          cd ..

      - name: Build backend_followService
        run: |
          cd backend_followService
          mvn -B clean package -DskipTests
          cd ..

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push backend_userService image
        uses: docker/build-push-action@v4
        with:
          context: ./backend_userService
          file: ./backend_userService/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_userService:latest
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_userService:${{ env.IMAGE_TAG }}

      - name: Build & push backend_messageService image
        uses: docker/build-push-action@v4
        with:
          context: ./backend_messageService
          file: ./backend_messageService/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_messageService:latest
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_messageService:${{ env.IMAGE_TAG }}

      - name: Build & push backend_nearbyService image
        uses: docker/build-push-action@v4
        with:
          context: ./backend_nearbyService
          file: ./backend_nearbyService/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_nearbyService:latest
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_nearbyService:${{ env.IMAGE_TAG }}

      - name: Build & push backend_followService image
        uses: docker/build-push-action@v4
        with:
          context: ./backend_followService
          file: ./backend_followService/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_followService:latest
            ${{ env.DOCKERHUB_NAMESPACE }}/backend_followService:${{ env.IMAGE_TAG }}

      - name: Build & push frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_NAMESPACE }}/frontend:latest
            ${{ env.DOCKERHUB_NAMESPACE }}/frontend:${{ env.IMAGE_TAG }}
